<script type="module">
    // ---------- MAIN APPLICATION WITH FIREBASE ----------
    import { getDocs, addDoc, updateDoc, deleteDoc, doc, query, orderBy } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

    // ---------- CONFIG ----------
    const ADMIN_PASSWORD = "UsmanRasuli890";
    const WHATSAPP_NUMBER = '15023890653';
    const EMAIL_ADDRESS = 'UsmanRasuli65@gmail.com';

    document.getElementById('whatsappBtn').href = `https://wa.me/${WHATSAPP_NUMBER}?text=Hello%20I%20am%20interested%20in%20your%20rug`;
    document.getElementById('emailBtn').href = `mailto:${EMAIL_ADDRESS}`;

    // ---------- GLOBAL STATE ----------
    let products = [];
    let cart = JSON.parse(localStorage.getItem('cart')) || [];
    let currentFilter = 'All';
    let adminAuthenticated = false;
    let editingId = null;

    // ---------- FIREBASE HELPERS ----------
    async function loadProductsFromFirebase() {
        try {
            const q = query(productsCollection, orderBy('name'));
            const querySnapshot = await getDocs(q);
            products = [];
            querySnapshot.forEach((docSnap) => {
                products.push({ id: docSnap.id, ...docSnap.data() });
            });
            renderProducts();
            if (adminAuthenticated) renderAdminProductList();
        } catch (error) {
            console.error("Error loading products: ", error);
            alert("Failed to load products. Make sure Firestore is enabled in test mode.");
        }
    }

    async function addProductToFirebase(product) {
        try {
            const docRef = await addDoc(productsCollection, product);
            product.id = docRef.id;
            products.push(product);
            renderProducts();
            if (adminAuthenticated) renderAdminProductList();
            alert("Product added successfully!");
        } catch (error) {
            console.error("Error adding product: ", error);
            alert("Failed to add product. Check Firestore rules (must be in test mode).");
        }
    }

    async function updateProductInFirebase(id, updatedData) {
        try {
            const productRef = doc(db, 'products', id);
            await updateDoc(productRef, updatedData);
            const index = products.findIndex(p => p.id === id);
            if (index !== -1) {
                products[index] = { ...products[index], ...updatedData };
            }
            renderProducts();
            if (adminAuthenticated) renderAdminProductList();
            alert("Product updated successfully!");
        } catch (error) {
            console.error("Error updating product: ", error);
            alert("Failed to update product.");
        }
    }

    async function deleteProductFromFirebase(id) {
        try {
            await deleteDoc(doc(db, 'products', id));
            products = products.filter(p => p.id !== id);
            renderProducts();
            if (adminAuthenticated) renderAdminProductList();
            cart = cart.filter(c => c.id !== id);
            saveCart();
            alert("Product deleted.");
        } catch (error) {
            console.error("Error deleting product: ", error);
            alert("Failed to delete product.");
        }
    }

    async function deleteAllProductsFromFirebase() {
        try {
            const querySnapshot = await getDocs(productsCollection);
            const deletions = [];
            querySnapshot.forEach((docSnap) => {
                deletions.push(deleteDoc(doc(db, 'products', docSnap.id)));
            });
            await Promise.all(deletions);
            products = [];
            renderProducts();
            if (adminAuthenticated) renderAdminProductList();
            cart = [];
            saveCart();
            alert("All products deleted.");
        } catch (error) {
            console.error("Error deleting all: ", error);
            alert("Failed to delete all products.");
        }
    }

    // ---------- RENDER PRODUCTS ----------
    function renderProducts() {
        const grid = document.getElementById('productGrid');
        const filtered = currentFilter === 'All' ? products : products.filter(p => p.size === currentFilter);
        grid.innerHTML = '';
        filtered.forEach(prod => {
            const card = document.createElement('div');
            card.className = 'product-card fade-scroll';
            card.innerHTML = `
                <img class="product-img" src="${prod.image || 'https://images.unsplash.com/photo-1600166898405-da9535204843?w=400'}" alt="${prod.name}">
                <div class="card-content">
                    <div class="product-name">${prod.name}</div>
                    <div class="product-size">${prod.size}</div>
                    <div class="product-desc">${prod.desc || 'hand knotted'}</div>
                    <button class="add-btn" data-id="${prod.id}">add to bag</button>
                </div>
            `;
            grid.appendChild(card);
        });

        document.querySelectorAll('.add-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const id = e.target.dataset.id;
                const product = products.find(p => p.id === id);
                if (product) { 
                    cart.push(product); 
                    saveCart(); 
                    showCartDropdown(); 
                }
            });
        });

        // scroll reveal
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(e => { if (e.isIntersecting) e.target.classList.add('revealed'); });
        }, { threshold: 0.2 });
        document.querySelectorAll('.fade-scroll').forEach(el => observer.observe(el));
    }

    // ---------- CART FUNCTIONS ----------
    function saveCart() {
        localStorage.setItem('cart', JSON.stringify(cart));
        updateCartUI();
    }

    function updateCartUI() {
        document.getElementById('cartCount').innerText = cart.length;
        const container = document.getElementById('cartItemsContainer');
        if (!container) return;
        if (cart.length === 0) { container.innerHTML = '<p style="color:#9e7e5e;">your bag is empty</p>'; return; }
        container.innerHTML = '';
        cart.forEach((item, idx) => {
            const div = document.createElement('div');
            div.className = 'cart-item';
            div.innerHTML = `
                <img src="${item.image}" alt="thumb">
                <div class="cart-item-info">
                    <div class="cart-item-name">${item.name}</div>
                    <div>${item.size}</div>
                </div>
                <button class="cart-item-remove" data-index="${idx}">✕</button>
            `;
            container.appendChild(div);
        });
        document.querySelectorAll('.cart-item-remove').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const index = e.target.dataset.index;
                cart.splice(index, 1);
                saveCart();
                updateCartUI();
            });
        });
    }

    function showCartDropdown() {
        document.getElementById('cartDropdown').classList.add('show');
    }

    // ---------- FILTER BUTTONS ----------
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const size = btn.getAttribute('data-size');
            currentFilter = size || 'All';
            renderProducts();
        });
    });

    // ---------- ADMIN PANEL (Secret: Ctrl+Shift+A) ----------
    const loginModal = document.getElementById('loginModal');
    const adminModal = document.getElementById('adminModal');
    const closeLogin = document.getElementById('closeLoginModal');
    const closeAdmin = document.getElementById('closeAdminModal');
    const submitPassword = document.getElementById('submitPassword');
    const passwordInput = document.getElementById('adminPasswordInput');
    const loginError = document.getElementById('loginError');
    const cancelEditBtn = document.getElementById('cancelEditBtn');
    const deleteAllBtn = document.getElementById('deleteAllBtn');

    function showLoginModal() { loginModal.classList.add('show'); }
    function hideLoginModal() { loginModal.classList.remove('show'); passwordInput.value = ''; loginError.innerText = ''; }
    function showAdminModal() { adminModal.classList.add('show'); renderAdminProductList(); }
    function hideAdminModal() { adminModal.classList.remove('show'); resetAdminForm(); }

    closeLogin.addEventListener('click', hideLoginModal);
    closeAdmin.addEventListener('click', hideAdminModal);

    document.addEventListener('keydown', (e) => {
        if (e.ctrlKey && e.shiftKey && e.key === 'A') {
            e.preventDefault();
            if (adminAuthenticated) {
                showAdminModal();
            } else {
                showLoginModal();
            }
        }
    });

    submitPassword.addEventListener('click', () => {
        if (passwordInput.value === ADMIN_PASSWORD) {
            adminAuthenticated = true;
            hideLoginModal();
            showAdminModal();
        } else {
            loginError.innerText = 'incorrect password';
        }
    });

    loginModal.addEventListener('click', (e) => {
        if (e.target === loginModal) hideLoginModal();
    });
    adminModal.addEventListener('click', (e) => {
        if (e.target === adminModal) hideAdminModal();
    });

    // ---------- ADMIN RENDER LIST ----------
    async function renderAdminProductList() {
        const adminDiv = document.getElementById('adminProductList');
        if (products.length === 0) {
            adminDiv.innerHTML = '<p style="color:#d8c09e;">No products yet. Add some above.</p>';
            return;
        }
        adminDiv.innerHTML = '<h4 style="margin: 1rem 0; color:#ebd3b5;">manage existing rugs</h4>';
        products.forEach(p => {
            const item = document.createElement('div');
            item.className = 'admin-item';
            item.innerHTML = `
                <img src="${p.image}" alt="">
                <span style="flex:1;"><strong>${p.name}</strong> (${p.size})</span>
                <button class="product-edit" data-id="${p.id}" style="background:#9f825d;">✎ edit</button>
                <button class="product-delete" data-id="${p.id}" style="background:#b34a4a;">delete</button>
            `;
            adminDiv.appendChild(item);
        });

        document.querySelectorAll('.product-edit').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const id = e.target.dataset.id;
                openEditProduct(id);
            });
        });

        document.querySelectorAll('.product-delete').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const id = e.target.dataset.id;
                if (confirm('Delete this product?')) {
                    deleteProductFromFirebase(id);
                }
            });
        });
    }

    function openEditProduct(id) {
        const product = products.find(p => p.id === id);
        if (!product) return;
        editingId = id;
        document.getElementById('prodName').value = product.name;
        document.getElementById('prodSize').value = product.size;
        document.getElementById('prodDesc').value = product.desc || '';
        const preview = document.getElementById('imagePreview');
        preview.src = product.image;
        preview.style.display = 'inline-block';
        document.getElementById('addProductBtn').textContent = 'Update product';
        cancelEditBtn.style.display = 'inline-block';
    }

    function resetAdminForm() {
        document.getElementById('prodName').value = '';
        document.getElementById('prodSize').value = 'Small';
        document.getElementById('prodDesc').value = '';
        document.getElementById('imagePreview').style.display = 'none';
        document.getElementById('imagePreview').src = '';
        document.getElementById('prodImageFile').value = '';
        document.getElementById('addProductBtn').textContent = 'Add product';
        cancelEditBtn.style.display = 'none';
        editingId = null;
    }

    // ---------- ADD/UPDATE PRODUCT ----------
    document.getElementById('addProductBtn').addEventListener('click', async () => {
        const name = document.getElementById('prodName').value.trim();
        const size = document.getElementById('prodSize').value;
        const desc = document.getElementById('prodDesc').value.trim() || 'handwoven wool';
        const fileInput = document.getElementById('prodImageFile');
        let image = null;

        if (fileInput.files.length > 0) {
            try {
                image = await fileToBase64(fileInput.files[0]);
            } catch (e) { 
                alert('Image conversion failed: ' + e.message); 
                return; 
            }
        } else if (editingId) {
            const existing = products.find(p => p.id === editingId);
            image = existing.image;
        } else {
            image = 'https://images.unsplash.com/photo-1600166898405-da9535204843?w=400';
        }

        if (!name) { alert('Name is required'); return; }

        const productData = { name, size, desc, image };

        if (editingId) {
            await updateProductInFirebase(editingId, productData);
        } else {
            await addProductToFirebase(productData);
        }
        resetAdminForm();
    });

    cancelEditBtn.addEventListener('click', resetAdminForm);

    // Delete all products
    deleteAllBtn.addEventListener('click', async () => {
        if (confirm('Delete ALL products? This cannot be undone.')) {
            await deleteAllProductsFromFirebase();
        }
    });

    // Helper: file to base64
    function fileToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = (error) => reject(error);
        });
    }

    // Image preview
    document.getElementById('prodImageFile').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('imagePreview').src = e.target.result;
                document.getElementById('imagePreview').style.display = 'inline-block';
            };
            reader.readAsDataURL(file);
        }
    });

    // Cart dropdown
    document.getElementById('cartIcon').addEventListener('click', (e) => {
        e.stopPropagation();
        document.getElementById('cartDropdown').classList.toggle('show');
    });
    document.getElementById('closeCart').addEventListener('click', () => {
        document.getElementById('cartDropdown').classList.remove('show');
    });

    document.addEventListener('click', (e) => {
        if (!e.target.closest('.cart-area')) {
            document.getElementById('cartDropdown').classList.remove('show');
        }
    });

    // Welcome overlay
    window.addEventListener('load', () => {
        setTimeout(() => {
            document.getElementById('welcome-overlay').classList.add('fade-out');
            setTimeout(() => {
                document.getElementById('welcome-overlay').style.display = 'none';
                document.body.classList.add('loaded');
            }, 1400);
        }, 2000);
    });

    // Initial load from Firebase
    loadProductsFromFirebase();
    updateCartUI();
</script>
